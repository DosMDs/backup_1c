# Backup 1C

Backup 1C — это утилита на Python для автоматизации создания резервных копий баз данных 1С и их синхронизации с Яндекс.Диском. Проект использует `ibcmd` для выгрузки баз, SQLAlchemy для работы с локальной базой данных SQLite и библиотеку `yadisk` для интеграции с Яндекс.Диском.

## Основные возможности

- Создание резервных копий баз данных 1С с помощью `ibcmd`.
- Хранение информации о базах и файлах в SQLite.
- Синхронизация бэкапов с Яндекс.Диском с поддержкой вложенных каталогов.
- Автоматическое удаление устаревших бэкапов (по умолчанию старше 90 дней).
- Логирование всех операций с ротацией логов.
- Тестирование с использованием pytest.

## Требования

- Python 3.11+
- Установленная платформа 1С:Предприятие (для `ibcmd`)
- SQLite (встроен в Python)
- Яндекс.Диск API токен

## Установка

1. **Клонируйте репозиторий**:

   ```bash
   git clone https://github.com/DosMDs/backup_1c.git
   cd backup_1c
   ```

2. **Установите зависимости**: Используйте Poetry для управления зависимостями:

   ```bash
   poetry install
   ```

3. **Настройте окружение**: Создайте файл .env в корне проекта и укажите необходимые переменные:

   ```env
   LOG_PATH=logs/app.log
   TEMP_PATH=tmp
   DB_PATH=app.sqlite3
   BACKUP_PATH=backup
   ENTERPRISE_PATH=/opt/1cv8/x86_64/
   ENTERPRISE_VERSION=8.3.20  # Опционально, если не указана, ищет последнюю версию
   DB_SERVER=localhost
   DBMS=PostgreSQL
   DB_USER=your_db_user
   DB_PASS=your_db_password
   BACKUP_FILE_LIFETIME=90
   YANDEX_DISK_TOKEN=your_yandex_disk_token
   ```

4. **Инициализируйте базу данных**: Примените миграции с помощью Alembic:

   ```bash
   poetry run alembic upgrade head
   ```

## Использование

1. **Запустите программу**:

   ```bash
   poetry run python backup_1c/main.py
   ```

   Это выполнит создание бэкапов и синхронизацию с Яндекс.Диском.

2. **Логи**: Результаты работы записываются в файл, указанный в LOG_PATH (по умолчанию logs/app.log).

3. **Добавление базы для обработки**: Программа обрабатывает базы что указаны в таблице `database_creds`

   Пример множественного добавления баз:

   ```bash
   sqlite3 app.sqlite3
   SQLite version 3.45.1 2024-01-30 16:01:20
   Enter ".help" for usage hints.
   sqlite> INSERT INTO database_creds(db_name, username, password) VALUES
   # Указывается имя базы данных в СУБД, Администратор базы и его пароль
   ('bp', 'Бухгалтер', 'ПарольПользователя'),
   # Если нет пароля просто передаем пустую строку
   ('retail', 'Бухгалтер', ''),
   # Если пользователя нет то передаем пустые строки
   ('zup', '', '');
   ```

### Пример работы

- Создаётся бэкап базы retail → /backup/retail/retail_2025-02-25.dt.
- Файл добавляется в SQLite со статусом NEW.
- Синхронизируется на Яндекс.Диск в /backups/retail/retail_2025-02-25.dt.
- Устаревшие файлы (старше 90 дней) удаляются.

## Структура проекта

    ```text
    .
    ├── alembic.ini         # Конфигурация миграций Alembic
    ├── app.sqlite3         # Локальная база данных SQLite
    ├── backup/             # Директория для локальных бэкапов
    ├── backup_1c/          # Основной модуль
    │   ├── configs/        # Конфигурации (логи, БД, переменные окружения)
    │   ├── backup.py       # Логика создания бэкапов и синхронизации
    │   ├── db_utils.py     # Утилиты для работы с SQLite
    │   ├── main.py         # Точка входа
    │   ├── models.py       # ORM-модели SQLAlchemy
    │   ├── utils.py        # Общие утилиты
    │   └── yadisk_utils.py # Интеграция с Яндекс.Диском
    ├── logs/               # Логи приложения
    ├── migrations/         # Миграции базы данных
    ├── tests/              # Тесты с использованием pytest
    ├── poetry.lock         # Зависимости Poetry
    ├── pyproject.toml      # Конфигурация проекта
    └── README.md           # Этот файл
    ```

## Тестирование

Запустите тесты с помощью pytest:

```bash
poetry run pytest
```

Для генерации отчёта покрытия:

```bash
poetry run pytest --cov=backup_1c --cov-report=html
```

Отчёт будет сохранён в htmlcov/.

## Конфигурация переменных окружения

| Переменная           | Описание                          | Значение по умолчанию         |
| -------------------- | --------------------------------- | ----------------------------- |
| LOG_PATH             | Путь к файлу логов                | logs/app.log                  |
| TEMP_PATH            | Временная директория              | tmp                           |
| DB_PATH              | Путь к SQLite базе                | app.sqlite3                   |
| BACKUP_PATH          | Директория для бэкапов            | backup                        |
| ENTERPRISE_PATH      | Путь к платформе 1С               | /opt/1cv8/x86_64/             |
| ENTERPRISE_VERSION   | Версия платформы 1С (опционально) | Последняя найденная           |
| DB_SERVER            | Сервер базы данных                | localhost                     |
| DBMS                 | Тип СУБД для ibcmd                | PostgreSQL                    |
| DB_USER              | Пользователь БД                   | Обязательно                   |
| DB_PASS              | Пароль БД                         | Обязательно                   |
| BACKUP_FILE_LIFETIME | Время жизни бэкапов (дни)         | 90                            |
| YANDEX_DISK_TOKEN    | Токен Яндекс.Диска                | Обязательно для синхронизации |

## Разработка

- Используйте `poetry add <package>` для добавления новых зависимостей.
- Добавляйте миграции с помощью `poetry run alembic revision --autogenerate -m "описание"`.
- Пишите тесты в папке `tests/`.

## Лицензия

MIT License. См. файл `LICENSE` (если добавлен).

## Контакты

Если у вас есть вопросы или предложения, пишите на dosmds@gmail.com.
